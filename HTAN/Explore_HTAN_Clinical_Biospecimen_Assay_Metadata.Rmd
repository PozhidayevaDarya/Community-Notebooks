---
title: "Explore HTAN Clinicial, Biospecimen, and Assay Metadata"
author: "Vesteinn Þórsson, ISB (Vesteinn.Thorsson@isbscience.org)"
date: "Edited 20 June, 2022"
output:
  html_document:
    highlight: tango
    toc: true
    toc_float:
      collapsed: TRUE
      smooth_scroll: false
---
```{r global options, echo = FALSE}
#List other global opts here if relevant
knitr::opts_chunk$set(fig.align="center") #Figures should be centered
## Utility to parse participant ID from other HTAN ID
participant_from_other_htan_id<- function(a){str_c(str_split(a,"_")[[1]][1:2],collapse="_")}
```

# 1. Introduction & Overview 

[HTAN](https://humantumoratlas.org/) is a National Cancer Institute (NCI)-funded Cancer Moonshot$^{SM}$ initiative to construct 3-dimensional atlases of the dynamic cellular, morphological, and molecular features of human cancers as they evolve from precancerous lesions to advanced disease. [Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469) 

Clinical data, sample biospecimen data and assay files in HTAN have a rich set of annotations supplied by HTAN data contributors.  These annotations are made according to the [HTAN Data model](https://data.humantumoratlas.org/standards), a set of standards defined by the HTAN consortium. The supplied values of these attributes have been collected into comprehensive data tables on the cloud, using the Google BigQuery structure that is part of Google Cloud Project.

### 1.1 Goal

This example notebook illustrates how to make use of HTAN Google BigQuery metadata tables to tabulate and plot available HTAN clinical, biospecimen, and assay metadata describing files available from [HTAN](https://data.humantumoratlas.org/). Summaries for other available metadata attributes can be generated by extending these examples.

### 1.2 Inputs, Outputs, & Data

The originating data can be found on the [HTAN Data Portal]([HTAN](https://data.humantumoratlas.org/)), and the compiled tables on ISB-CGC (location pending).

### 1.3 Notes

The tables correspond to HTAN Data Version 2.

# 2. Environment & Library Setup
```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(bigrquery))
suppressMessages(library(knitr))
```

# 3. Google Authentication

Running the BigQuery cells in this notebook requires a Google Cloud Project, instructions for creating a project can be found in the [Google Documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console). The instance needs to be authorized to bill the project for queries. For more information on getting started in the cloud see 'Quick Start Guide to ISB-CGC' and alternative authentication methods can be found in the [Google Documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console).

```{r}

billing <- 'your_project_number' # Insert your project ID in the ''
if (billing == 'your_project_number') {
  print('Please update the project number with your Google Cloud Project')
}

# Connect to BigQuery
#con <- dbConnect(
#  bigrquery::bigquery(),
#  project = billing,
#)


```


# 4. Analyzing Clinical Data in HTAN

In the [HTAN Data model](https://data.humantumoratlas.org/standards), [Tier 1 Clinical Data](https://data.humantumoratlas.org/standard/clinical) has seven contributions: Demographics, Diagnosis, Exposure, Family History, Follow Up, Molecular Test, and Therapy. All of HTAN demographic data is collected into a single Demographics table (*htan-dcc.htan_isb_cgc.Demographics*) in Google BigQuery. The same is true of Diagnosis, and so on. 

### 4.1 Demographics

Let's look at demographic distributions in HTAN. We begin by constructing an SQL query (as a string), then sending that as query to HTAN Google BigQuery to retrieve the Demographics table. We remove a few unnneeded bookkeeping columns.

```{r cache=TRUE}
sql  <- "select * from `isb-project-zero.HTAN.clinical_tier1_demographics_current`"
tb <- bq_project_query(billing, sql)
demographics <- bq_table_download(tb)
demographics <- demographics %>% select(-entityId,-Component,-`Data_Release`) %>% distinct()
demographics$HTAN_Center <- gsub("HTAN ","",demographics$HTAN_Center)
```

The number of rows of this table is the mumber of participants for which demographics is reported: nrow(demographics)=`r nrow(demographics)`. The list of IDs of all HTAN Participants with demographic annotations is 

```{r}
participant_list <- demographics$HTAN_Participant_ID 
```

There are length(participant_list)=`r length(participant_list)` participants with demographic annotations.  Participants per HTAN center

```{r echo=T}
participant_count_by_center <- demographics %>% select(HTAN_Center) %>% group_by(HTAN_Center) %>% tally()
participant_count_by_center %>% kable()
```

You will see some differences between this table and the case counts on the [HTAN Data Portal]([HTAN](https://data.humantumoratlas.org/)). (Some contributing factors: This notebook is fixed to HTAN data Release 2.0 while the portal has additional data; the portal case inclusion criterion does not correspond to this simple row count.)

The number of columns in the Demographics table, ncol(demographics)=`r ncol(demographics)`, is the number of demographic attributes. The attributes are 
```{r}
colnames(demographics)
```
These are the attributes of the HTAN [Clinical Tier 1 Demographics Data Model](https://data.humantumoratlas.org/standard/clinical), along with a few general attributes.

#### 4.1.1 Race
Race is one of the Demographics attributes. Let's tabulate reported Race in HTAN and report fraction in percent. 
```{r}
demographics %>% group_by(Race) %>% tally() %>% mutate(Percent=round(100*n/nrow(demographics),1)) %>% kable() 
```

Here is barchart of the distribution
```{r fig.dim = c(6, 3)}
demographics %>% ggplot(aes(y=Race,fill=HTAN_Center)) + 
  geom_bar() + theme_classic() 
```

#### 4.1.2 Gender

Similarly, here is a barchart for Gender

```{r}
demographics %>% group_by(Gender) %>% tally() %>% mutate(Percent=round(100*n/nrow(demographics),1)) %>% kable()
```

```{r fig.dim = c(6, 3)}
demographics %>% ggplot(aes(y=Gender,fill=HTAN_Center)) + 
  geom_bar() + theme_classic() 
```

# 5. Relevant Citations and Links (if applicable)

[Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469)
